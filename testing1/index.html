<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Valuation Pro - Institutional Report</title>

    <!-- 0. Process Shim (Critical for React on Vercel) -->
    <script>
        window.process = { env: { NODE_ENV: 'production' } };
    </script>

    <!-- 1. Libraries -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS (Load before config) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Charts & Icons -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- 2. Config & Styles -->
    <script>
        // Safer Tailwind Config Initialization
        window.onload = function() {
            if (window.tailwind) {
                tailwind.config = {
                    theme: {
                        extend: {
                            colors: {
                                msft: { blue: '#0078D4', dark: '#242424', bg: '#f3f2f1' },
                                val: { green: '#2ecc71', blue: '#3498db', orange: '#f39c12', red: '#e74c3c', barRed: '#C74634', grayBar: '#b0bec5' }
                            },
                            boxShadow: { 'card': '0 4px 12px rgba(0,0,0,0.06)', 'floating': '0 10px 30px rgba(0,0,0,0.06)' },
                            fontFamily: { sans: ['Segoe UI', 'Roboto', 'Helvetica', 'Arial', 'sans-serif'] }
                        }
                    }
                };
            }
        };
    </script>
    <style>
        body { background-color: #f3f2f1; color: #242424; }
        .gauge-container { position: relative; height: 30px; background: #eee; border-radius: 15px; overflow: hidden; display: flex; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1); }
        .gauge-segment { height: 100%; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.8em; font-weight: bold; }
        .price-marker { position: absolute; top: -5px; bottom: -5px; width: 4px; background: #c0392b; border: 2px solid white; z-index: 10; box-shadow: 0 2px 5px rgba(0,0,0,0.3); transition: left 1s ease-out; }
        .price-flag { position: absolute; top: -28px; background: #c0392b; color: white; font-size: 0.7em; padding: 2px 6px; border-radius: 4px; font-weight: bold; white-space: nowrap; transform: translateX(-50%); }
        .price-flag::after { content: ""; position: absolute; bottom: -4px; left: 50%; transform: translateX(-50%); border-width: 4px 4px 0; border-style: solid; border-color: #c0392b transparent transparent transparent; }
        .bar-chart-container { display: flex; align-items: flex-end; justify-content: space-between; height: 220px; padding: 20px 40px 0 40px; background: #fafafa; border-radius: 8px; border-bottom: 1px solid #eee; }
        .css-bar-group { display: flex; flex-direction: column; align-items: center; width: 10%; position: relative; height: 100%; justify-content: flex-end; }
        .css-bar { width: 40px; border-radius: 4px 4px 0 0; transition: height 0.5s ease; }
        .css-bar-val { margin-bottom: 8px; text-align: center; font-weight: bold; color: #555; font-size: 0.9em; }
        .css-bar-label { margin-top: 10px; font-size: 0.8em; color: #666; font-weight: 600; text-align: center; height: 30px; }
        .diagram-box { background: white; padding: 20px; border: 1px solid #eee; border-radius: 8px; text-align: center; overflow-x: auto; margin-bottom: 30px; box-shadow: 0 4px 12px rgba(0,0,0,0.06); }
        .report-table th { background-color: #0078D4; color: white; padding: 12px; text-align: left; }
        .report-table td { padding: 12px; border-bottom: 1px solid #eee; }
        .report-table tr:nth-child(even) { background-color: #fcfcfc; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- CONSTANTS ---
        const API_KEY = "692ff0e71412a4.89947654"; // Your Key
        
        // --- HELPER FUNCTIONS ---
        const formatNumber = (num) => {
            if (num === null || num === undefined || isNaN(num)) return "N/A";
            const absNum = Math.abs(num);
            if (absNum > 1e9) return (num / 1e9).toFixed(1) + "B";
            if (absNum > 1e6) return (num / 1e6).toFixed(1) + "M";
            return num.toLocaleString();
        };

        const calculateGrowth = (current, previous) => {
            if (!current || !previous || previous == 0) return null;
            return ((current - previous) / Math.abs(previous) * 100).toFixed(1);
        };

        // --- 4. FALLBACK DATA (OFFLINE DATABASE) ---
        // High-quality static data for specific tickers to prevent "N/A" or "$100"
        const getFallbackData = (ticker) => {
            const t = ticker.toUpperCase();
            
            // TSLA Backup
            if (t.includes('TSLA')) {
                return {
                    name: "Tesla Inc", ticker: "TSLA.US", price: 446.74, // Live price will overwrite this
                    description: "Tesla, Inc. designs, develops, manufactures, leases, and sells electric vehicles, and energy generation and storage systems. (Data Source: Offline Database)",
                    pe_forward: 151.4, market_cap: 1420000000000, ebitda_margin: 0.145, rating: "Buy", isFallback: true,
                    history: [
                        { year: '2020', val: 1100.0 }, { year: '2021', val: 342.5 },
                        { year: '2022', val: 36.8 }, { year: '2023', val: 82.4 },
                        { year: '2024', val: 135.0 }, { year: 'Now', val: 151.4, type: 'current' }
                    ],
                    estimates: [
                        { year: 2025, eps: "2.95", rev: 128500000000, eps_growth: null, rev_growth: null },
                        { year: 2026, eps: "4.43", rev: 156800000000, eps_growth: "50.1", rev_growth: "22.0" },
                        { year: 2027, eps: "6.66", rev: 194432000000, eps_growth: "50.3", rev_growth: "24.0", isProjected: false }
                    ],
                    multiples: { bear: 60, base: 120, bull: 180 },
                    swot: { s: ["Market Leader"], w: ["High Valuation"], o: ["Robotaxi"], t: ["Competition"] },
                    supply_chain: `graph LR; Panasonic-->TSLA; CATL-->TSLA; TSLA-->Consumer`,
                    ecosystem: `graph TD; EV-->FSD; Energy-->Grid`
                };
            }
            
            // NVDA Backup (Corrected Data - No more $100)
            if (t.includes('NVDA')) {
                return {
                    name: "NVIDIA Corp", ticker: "NVDA.US", price: 144.00, // Reference price
                    description: "NVIDIA Corporation focuses on personal computer (PC) graphics, graphics processing unit (GPU) and also on artificial intelligence (AI). (Data Source: Offline Database)",
                    pe_forward: 38.5, market_cap: 3500000000000, ebitda_margin: 0.55, rating: "Strong Buy", isFallback: true,
                    history: [
                        { year: '2020', val: 85.0 }, { year: '2021', val: 90.5 },
                        { year: '2022', val: 65.0 }, { year: '2023', val: 110.0 },
                        { year: '2024', val: 75.0 }, { year: 'Now', val: 38.5, type: 'current' }
                    ],
                    estimates: [
                        { year: 2025, eps: "3.85", rev: 150000000000, eps_growth: null, rev_growth: null },
                        { year: 2026, eps: "4.95", rev: 190000000000, eps_growth: "28.5", rev_growth: "26.6" },
                        { year: 2027, eps: "5.80", rev: 220000000000, eps_growth: "17.1", rev_growth: "15.7" }
                    ],
                    multiples: { bear: 25, base: 40, bull: 55 },
                    swot: { s: ["AI Monopoly"], w: ["China Export Ban"], o: ["Sovereign AI"], t: ["Custom Silicon"] },
                    supply_chain: `graph LR; TSMC-->NVDA; SK_Hynix-->NVDA; NVDA-->Microsoft; NVDA-->Meta`,
                    ecosystem: `graph TD; GPU-->CUDA; CUDA-->Omniverse`
                };
            }

            // No generic fallback to avoid "$100" confusion. Returns null to show specific error if unknown ticker.
            return null;
        };

        // --- 5. ROBUST FETCH (Vercel Optimized) ---
        const robustFetch = async (url) => {
            // 1. Try Direct (Fastest)
            try {
                const res = await fetch(url);
                if (res.ok) return await res.json();
            } catch (e) {
                // console.warn("Direct fetch failed, switching to proxy...");
            }

            // 2. Try Stable Proxy (corsproxy.io)
            try {
                const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(url)}`;
                const resProxy = await fetch(proxyUrl);
                if (resProxy.ok) return await resProxy.json();
            } catch (e) {
                console.error("Proxy failed");
            }

            throw new Error("API Unreachable");
        };

        // --- 6. SMART CACHE SYSTEM ---
        const CACHE_DURATION = 1000 * 60 * 60 * 24; // 24 Hours

        const saveToDatabase = (ticker, data) => {
            try {
                const cacheData = { timestamp: Date.now(), data: data };
                localStorage.setItem(`vp_db_${ticker}`, JSON.stringify(cacheData));
            } catch (e) {}
        };

        const loadFromDatabase = (ticker) => {
            try {
                const cached = localStorage.getItem(`vp_db_${ticker}`);
                if (!cached) return null;
                const { timestamp, data } = JSON.parse(cached);
                if (Date.now() - timestamp > CACHE_DURATION) return null;
                return data;
            } catch (e) { return null; }
        };

        // --- COMPONENTS ---
        const Header = ({ onSearch }) => {
            const [input, setInput] = useState("");
            const handleSubmit = (e) => {
                e.preventDefault();
                let ticker = input.toUpperCase().trim();
                if (ticker.match(/^\d+$/)) ticker += ".HK"; 
                else if (ticker && !ticker.includes(".")) ticker += ".US";
                if(ticker) onSearch(ticker);
            };
            return (
                <nav className="bg-white border-b border-gray-200 px-8 py-4 flex justify-between items-center sticky top-0 z-50 shadow-sm">
                    <div className="flex items-center gap-3">
                        <div className="bg-msft-blue text-white p-2 rounded font-bold text-xl">VP</div>
                        <span className="text-xl font-bold text-msft-dark hidden sm:block">Valuation Pro</span>
                    </div>
                    <form onSubmit={handleSubmit} className="flex gap-2 w-full max-w-md">
                        <div className="relative w-full">
                            <input type="text" className="w-full border border-gray-300 rounded px-4 py-2 focus:outline-none focus:border-msft-blue transition" placeholder="Enter Ticker (e.g. NVDA)" value={input} onChange={(e) => setInput(e.target.value)} />
                            <i data-lucide="search" className="absolute right-3 top-2.5 text-gray-400 w-5 h-5"></i>
                        </div>
                        <button type="submit" className="bg-msft-blue text-white px-6 py-2 rounded font-bold hover:bg-blue-700 transition">Analysis</button>
                    </form>
                </nav>
            );
        };

        const ExecSummary = ({ data }) => (
            <div className="bg-[#f0f6ff] border border-[#cce4ff] p-6 rounded-md mb-8 border-l-[5px] border-l-msft-blue text-msft-dark shadow-sm">
                <div className="flex justify-between items-start">
                    <strong className="block text-lg mb-4 text-msft-blue">‚ö° Ê†∏ÂøÉÊ¥ûÂØü (Executive Summary)</strong>
                    {data.isFallback && <span className="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded font-bold">Offline Data Mode</span>}
                    {data.fromCache && <span className="bg-green-100 text-green-800 text-xs px-2 py-1 rounded font-bold">Cached Data</span>}
                </div>
                <p className="mb-4">
                    <strong>‰º∞ÂÄºË¶ñËßíÔºö</strong> {data.ticker} Áï∂ÂâçÂÉπÊ†ºÁÇ∫ <strong>${data.price}</strong>„ÄÇ
                    Â∏ÇÂ†¥È†ê‰º∞ÂÖ∂ FY{data.estimates[0].year} EPS ÁÇ∫ {data.estimates[0].eps ? '$'+data.estimates[0].eps : 'N/A'}„ÄÇ
                    ÁõÆÂâçÁöÑ Forward P/E Á¥ÑÁÇ∫ <strong>{data.pe_forward}x</strong>„ÄÇ
                </p>
                <p><strong>ÂãïÊÖã‰º∞ÂÄºÂçÄÈñìÔºö</strong> ÁÜäÂ∏Ç {data.multiples.bear}x / Âü∫Ê∫ñ {data.multiples.base}x / ÁâõÂ∏Ç {data.multiples.bull}x„ÄÇ</p>
            </div>
        );

        const KPIGrid = ({ data }) => {
            const growth = data.estimates[1]?.rev_growth;
            const growthColor = !growth ? 'text-gray-500' : Number(growth) > 0 ? 'text-val-green' : 'text-val-red';
            const growthText = !growth ? 'N/A' : (Number(growth) > 0 ? '+' + growth + '%' : growth + '%');
            return (
                <div className="grid grid-cols-2 md:grid-cols-4 gap-5 mb-10">
                    <div className="bg-white p-5 rounded border border-gray-200 text-center shadow-card"><span className="block text-3xl font-bold text-msft-blue">${data.price}</span><span className="text-xs text-gray-500 uppercase tracking-wider font-semibold">Live Price</span></div>
                    <div className="bg-white p-5 rounded border border-gray-200 text-center shadow-card"><span className="block text-3xl font-bold text-msft-blue">{data.pe_forward}x</span><span className="text-xs text-gray-500 uppercase tracking-wider font-semibold">Forward P/E</span></div>
                    <div className="bg-white p-5 rounded border border-gray-200 text-center shadow-card"><span className={`block text-3xl font-bold ${growthColor}`}>{growthText}</span><span className="text-xs text-gray-500 uppercase tracking-wider font-semibold">FY{data.estimates[1]?.year} Rev Growth</span></div>
                    <div className="bg-white p-5 rounded border border-gray-200 text-center shadow-card"><span className="block text-3xl font-bold text-val-blue">{data.rating}</span><span className="text-xs text-gray-500 uppercase tracking-wider font-semibold">Analyst Rating</span></div>
                </div>
            );
        };

        const PEHistoryChart = ({ history }) => {
            const maxVal = Math.max(...history.map(h => parseFloat(h.val) || 0));
            return (
                <div className="bg-white p-6 rounded border border-gray-200 shadow-card mb-8">
                     <span className="block text-lg font-bold text-gray-600 border-b border-gray-100 pb-2 mb-4">üìâ Historical Forward P/E Trend</span>
                    <p className="text-sm text-gray-500 mb-6">È°ØÁ§∫ÈÅéÂéª 5 Âπ¥ÁöÑ Realized Forward P/E„ÄÇ</p>
                    <div className="bar-chart-container">
                        {history.map((h, i) => {
                            if (!h.val || isNaN(h.val)) return <div key={i} className="css-bar-group"><span className="css-bar-val text-xs text-gray-400">N/A</span><div className="css-bar bg-gray-100" style={{height:'5px'}}></div><span className="css-bar-label">{h.year}</span></div>;
                            const heightPx = Math.min((parseFloat(h.val) / maxVal) * 140, 160); 
                            let bgColor = "#b0bec5"; let textColor = "#555";
                            if (h.type === 'current') { bgColor = "#0078D4"; textColor = "#0078D4"; }
                            return <div key={i} className="css-bar-group"><span className="css-bar-val" style={{color:textColor}}>{parseFloat(h.val).toFixed(1)}x</span><div className="css-bar" style={{ height: `${heightPx}px`, backgroundColor: bgColor }}></div><span className="css-bar-label" style={{color:textColor}}>{h.year}</span></div>;
                        })}
                    </div>
                </div>
            );
        };

        const GaugeBar = ({ label, estimates, currentPrice, dynamicMultiples }) => {
            if (!estimates.eps || estimates.eps <= 0) return null;
            const { bear, base, bull } = dynamicMultiples;
            const bearPrice = estimates.eps * bear;
            const basePrice = estimates.eps * base;
            const bullPrice = estimates.eps * bull;
            const min = bearPrice * 0.7; const max = bullPrice * 1.2; const range = max - min;
            let pct = ((currentPrice - min) / range) * 100; pct = Math.max(5, Math.min(95, pct)); 
            return (
                <div className="mb-8">
                    <div className="flex justify-between mb-1 text-sm font-bold text-gray-600"><span>{label}</span><span style={{color: '#3498db'}}>Fair Value</span></div>
                    <div className="gauge-container">
                        <div className="gauge-segment bg-val-blue w-1/3">Bear ({bear}x)</div><div className="gauge-segment bg-val-green w-1/3">Base ({base}x)</div><div className="gauge-segment bg-val-orange w-1/3">Bull ({bull}x)</div>
                        <div className="price-marker" style={{ left: `${pct}%` }}><div className="price-flag">Now</div></div>
                    </div>
                    <div className="flex justify-between mt-2 text-xs text-gray-400"><span>${bearPrice.toFixed(0)}</span><span className="font-bold text-gray-600">${basePrice.toFixed(0)}</span><span>${bullPrice.toFixed(0)}</span></div>
                </div>
            );
        };

        const ValuationSection = ({ data }) => {
            return (
                <div className="grid md:grid-cols-2 gap-8 mb-10">
                    <div className="bg-white p-6 rounded border border-gray-200 shadow-card">
                        <span className="block text-lg font-bold text-gray-600 border-b border-gray-100 pb-2 mb-6">‚öñÔ∏è Multi-Year Valuation</span>
                        <div className="text-xs text-gray-500 mb-4 bg-gray-50 p-2 rounded">Multiples: Bear {data.multiples.bear}x | Base {data.multiples.base}x | Bull {data.multiples.bull}x</div>
                        {data.estimates.map((est, i) => (<GaugeBar key={i} label={`FY${est.year} Est. (EPS ${est.eps ? '$' + est.eps : 'N/A'})`} estimates={est} currentPrice={data.price} dynamicMultiples={data.multiples} />))}
                    </div>
                    <div className="bg-white p-6 rounded border border-gray-200 shadow-card">
                        <span className="block text-lg font-bold text-gray-600 border-b border-gray-100 pb-2 mb-6">üöÄ Growth Forecast</span>
                        <div className="mb-6"><strong className="block text-sm mb-4 text-gray-600">EPS Growth Path</strong>
                            {data.estimates.map((est, i) => {
                                const widthPct = est.eps ? Math.min(100, (est.eps / Math.max(...data.estimates.map(e=>e.eps||0))) * 100) : 0;
                                return <div key={i} className="flex items-center mb-3"><span className="w-12 text-sm font-bold text-gray-500">{est.year}E</span><div className="flex-grow bg-gray-100 h-3 rounded-full mx-3 overflow-hidden">{est.eps ? <div className="h-full bg-val-barRed rounded-full" style={{width: `${widthPct}%`}}></div> : <span className="text-xs text-gray-400">N/A</span>}</div><span className="w-16 text-right font-bold text-gray-800">{est.eps ? '$'+est.eps : '-'}</span><span className="ml-2 text-xs font-bold text-val-green">{est.eps_growth ? '+'+est.eps_growth+'%' : ''}</span></div>
                            })}
                        </div>
                        <div><strong className="block text-sm mb-2 text-gray-600">Revenue Estimates</strong>
                            <table className="w-full text-sm border-t border-gray-100"><tbody>{data.estimates.map((est, i) => (<tr key={i} className="border-b border-gray-50 border-dashed"><td className="py-2 text-gray-600">{est.year} Est.</td><td className="py-2 text-right font-bold text-gray-800">{formatNumber(est.rev)}</td><td className="py-2 text-right font-bold text-val-green">{est.rev_growth ? '‚ñ≤ '+est.rev_growth+'%' : 'N/A'}</td></tr>))}</tbody></table>
                        </div>
                    </div>
                </div>
            );
        };

        const MermaidDiagram = ({ chart, title }) => {
            useEffect(() => { if(window.mermaid) mermaid.contentLoaded(); }, [chart]);
            return (<div className="mb-10"><h2 className="text-2xl text-gray-800 border-l-[6px] border-msft-blue pl-4 mb-6 font-bold">{title}</h2><div className="diagram-box"><div className="mermaid">{chart}</div></div></div>);
        };

        const AnalysisTables = ({ data }) => (
            <>
                <h2 className="text-2xl text-gray-800 border-l-[6px] border-msft-blue pl-4 mb-6 font-bold">5. Á´∂Áà≠ËàáË≤°Âãô (Fundamentals)</h2>
                <div className="bg-white p-6 rounded border border-gray-200 shadow-card mb-10"><h3 className="text-lg font-bold text-gray-700 mb-4">Competitor Matrix</h3><table className="report-table w-full text-center"><thead><tr><th>Peer</th><th className="text-center">Market Cap</th><th className="text-center">EBITDA Margin</th></tr></thead><tbody><tr className="bg-blue-50"><td className="font-bold text-msft-blue">{data.ticker}</td><td>{formatNumber(data.market_cap)}</td><td>{data.ebitda_margin ? (data.ebitda_margin * 100).toFixed(1) + '%' : 'N/A'}</td></tr></tbody></table></div>
            </>
        );

        const SWOT = ({ swot }) => (
            <div className="mb-12"><h2 className="text-2xl text-gray-800 border-l-[6px] border-msft-blue pl-4 mb-6 font-bold">6. Êà∞Áï•ÂàÜÊûê (SWOT)</h2><div className="grid md:grid-cols-2 gap-6"><div className="bg-white p-6 rounded shadow-card border-t-[4px] border-val-green"><h3 className="font-bold text-lg mb-4">üí™ Strengths</h3><ul className="list-disc pl-5 space-y-2 text-gray-600">{swot.s.map((item, i) => <li key={i}>{item}</li>)}</ul></div><div className="bg-white p-6 rounded shadow-card border-t-[4px] border-val-orange"><h3 className="font-bold text-lg mb-4">‚ö†Ô∏è Weaknesses</h3><ul className="list-disc pl-5 space-y-2 text-gray-600">{swot.w.map((item, i) => <li key={i}>{item}</li>)}</ul></div><div className="bg-white p-6 rounded shadow-card border-t-[4px] border-msft-blue"><h3 className="font-bold text-lg mb-4">üöÄ Opportunities</h3><ul className="list-disc pl-5 space-y-2 text-gray-600">{swot.o.map((item, i) => <li key={i}>{item}</li>)}</ul></div><div className="bg-white p-6 rounded shadow-card border-t-[4px] border-val-red"><h3 className="font-bold text-lg mb-4">üõ°Ô∏è Threats</h3><ul className="list-disc pl-5 space-y-2 text-gray-600">{swot.t.map((item, i) => <li key={i}>{item}</li>)}</ul></div></div></div>
        );

        const TradingViewWidget = ({ ticker }) => {
            const containerRef = useRef();
            useEffect(() => {
                if (!containerRef.current) return;
                containerRef.current.innerHTML = "";
                const script = document.createElement("script");
                script.src = "https://s3.tradingview.com/tv.js";
                script.async = true;
                script.onload = () => {
                    let tvTicker = ticker.includes("HK") ? `HKEX:${ticker.replace('.HK','')}` : `NASDAQ:${ticker.replace('.US','')}`;
                    new TradingView.widget({"width": "100%", "height": 500, "symbol": tvTicker, "interval": "D", "timezone": "Etc/UTC", "theme": "light", "style": "1", "locale": "en", "toolbar_bg": "#f1f3f6", "enable_publishing": false, "allow_symbol_change": true, "container_id": containerRef.current.id});
                };
                containerRef.current.appendChild(script);
            }, [ticker]);
            return (<div className="mb-10"><h2 className="text-2xl text-gray-800 border-l-[6px] border-msft-blue pl-4 mb-6 font-bold">1. ËÇ°ÂÉπËµ∞Âã¢Âúñ (Price Action)</h2><div id={`tv-${ticker}`} ref={containerRef} className="h-[500px] border border-gray-200 rounded-lg overflow-hidden shadow-card bg-white"></div></div>);
        };

        const App = () => {
            const [data, setData] = useState(null);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [ticker, setTicker] = useState("TSLA");

            const fetchData = async (sym) => {
                setLoading(true); setError(null);
                const cleanSym = sym.toUpperCase();
                
                try {
                    // 1. LIVE PRICE (Always Fetch from API via Proxy)
                    let currentPrice = 0;
                    try {
                        // Direct fetch may fail on Vercel due to CORS, so robustFetch will try proxy
                        const priceRes = await robustFetch(`https://eodhd.com/api/real-time/${cleanSym}?api_token=${API_KEY}&fmt=json`);
                        currentPrice = priceRes.close || priceRes.Price;
                    } catch(e) {
                        console.warn("Live price fetch failed, using fallback if available");
                    }

                    // 2. CHECK CACHE (Your "Database")
                    const cachedData = loadFromDatabase(cleanSym);
                    if (cachedData) {
                        console.log("Hit Cache");
                        if (currentPrice > 0) {
                            cachedData.price = currentPrice; // Update with live price
                            // Re-calc current PE
                            if (cachedData.estimates && cachedData.estimates[0].eps) {
                                cachedData.pe_forward = (currentPrice / cachedData.estimates[0].eps).toFixed(1);
                            }
                        }
                        cachedData.fromCache = true;
                        setData(cachedData);
                        setLoading(false);
                        return;
                    }

                    // 3. FETCH FUNDAMENTALS (If cache miss)
                    let fundData, histPriceData;
                    
                    try {
                        fundData = await robustFetch(`https://eodhd.com/api/fundamentals/${cleanSym}?api_token=${API_KEY}&fmt=json`);
                        histPriceData = await robustFetch(`https://eodhd.com/api/eod/${cleanSym}?fmt=json&from=2020-01-01&period=d&api_token=${API_KEY}`);
                    } catch (e) {
                        // Force Fallback if API fails
                        console.warn("API Failed, using Offline Backup");
                        const backup = getFallbackData(cleanSym);
                        if (backup) {
                            if(currentPrice > 0) backup.price = currentPrice; // Update backup with live price if available
                            setData(backup);
                            return;
                        }
                        throw new Error("Data Unavailable");
                    }

                    // --- DATA PROCESSING ---
                    const highlights = fundData.Highlights || {};
                    let earningsTrend = fundData.Earnings?.Trend || {};
                    const incomeHist = fundData.Financials?.Income_Statement?.yearly || {};
                    const incomeQuart = fundData.Financials?.Income_Statement?.quarterly || {};
                    
                    let trendArray = [];
                    if (Array.isArray(earningsTrend)) trendArray = earningsTrend;
                    else if (typeof earningsTrend === 'object' && earningsTrend !== null) trendArray = Object.values(earningsTrend);

                    const curYear = new Date().getFullYear();

                    // Estimates Logic
                    const getHybridEstimate = (targetYear) => {
                        let totalEPS = 0, totalRev = 0, quartersFound = 0;
                        Object.values(incomeQuart).forEach(q => {
                            if (!q.date) return;
                            if (new Date(q.date).getFullYear() === targetYear) {
                                totalEPS += parseFloat(q.epsActual || 0);
                                totalRev += parseFloat(q.totalRevenue || 0);
                                quartersFound++;
                            }
                        });
                        trendArray.forEach(val => {
                            if (!val || !val.date) return;
                            if (new Date(val.date).getFullYear() === targetYear) {
                                totalEPS += val.earningsEstimate || 0;
                                totalRev += val.revenueEstimate || 0;
                                quartersFound++;
                            }
                        });
                        if (quartersFound > 0 && totalRev > 0) return { eps: totalEPS.toFixed(2), rev: totalRev };
                        return null;
                    };

                    let est0 = { eps: highlights.EPSEstimateCurrentYear || getHybridEstimate(curYear)?.eps, rev: highlights.RevenueEstimateCurrentYear || getHybridEstimate(curYear)?.rev };
                    let est1 = { eps: highlights.EPSEstimateNextYear || getHybridEstimate(curYear + 1)?.eps, rev: highlights.RevenueEstimateNextYear || getHybridEstimate(curYear + 1)?.rev };
                    let est2 = getHybridEstimate(curYear + 2);
                    
                    let isYear2Projected = false;
                    if (!est2 || !est2.eps) {
                        if (est0.eps && est1.eps) {
                            const growth = (est1.eps - est0.eps) / Math.abs(est0.eps);
                            const safeGrowth = Math.min(Math.max(growth, -0.2), 0.4); 
                            est2 = { eps: (Number(est1.eps) * (1 + safeGrowth)).toFixed(2), rev: est1.rev * (1 + safeGrowth) };
                            isYear2Projected = true;
                        } else { est2 = { eps: null, rev: null }; }
                    }

                    const estimates = [
                        { year: curYear, eps: est0.eps, rev: est0.rev, eps_growth: null, rev_growth: null },
                        { year: curYear + 1, eps: est1.eps, rev: est1.rev, eps_growth: calculateGrowth(est1.eps, est0.eps), rev_growth: calculateGrowth(est1.rev, est0.rev) },
                        { year: curYear + 2, eps: est2.eps, rev: est2.rev, eps_growth: calculateGrowth(est2.eps, est1.eps), rev_growth: calculateGrowth(est2.rev, est1.rev), isProjected: isYear2Projected },
                    ];

                    const getYearEndPrice = (y) => {
                        if(!Array.isArray(histPriceData)) return null;
                        const yearEntries = histPriceData.filter(d => d.date.startsWith(y.toString()));
                        return yearEntries.length > 0 ? yearEntries[yearEntries.length - 1].close : null;
                    };
                    const getAnnualEPS = (y) => {
                         const entry = Object.values(incomeHist).find(d => d.date.startsWith(y.toString()));
                         return entry ? entry.eps : null;
                    };

                    const histYears = [2020, 2021, 2022, 2023, 2024];
                    const history = histYears.map(year => {
                        const price = getYearEndPrice(year);
                        let fwdEPS = null;
                        if (year < curYear - 1) fwdEPS = getAnnualEPS(year + 1);
                        else if (year === curYear - 1) fwdEPS = est0.eps;
                        let val = null;
                        if (price && fwdEPS && parseFloat(fwdEPS) !== 0) val = (price / parseFloat(fwdEPS)).toFixed(1);
                        return { year: year.toString(), val: val, type: 'hist' };
                    });
                    const currentFwdPE = est1.eps ? (currentPrice / est1.eps).toFixed(1) : "N/A";
                    history.push({ year: 'Now', val: currentFwdPE, type: 'current' });

                    // --- CIRCUIT BREAKER ---
                    // If calculated data is trash (too many N/As), use Backup
                    const validHistory = history.filter(h => h.val !== null).length;
                    if (validHistory < 3 && (cleanSym.includes('TSLA') || cleanSym.includes('NVDA'))) {
                        console.warn("Data quality poor, switching to backup");
                        const backup = getFallbackData(cleanSym);
                        if (backup) {
                            if(currentPrice > 0) backup.price = currentPrice;
                            setData(backup);
                            return;
                        }
                    }

                    const validPEs = history.map(h => parseFloat(h.val)).filter(v => !isNaN(v) && v > 0 && v < 500); 
                    let multiples = { bear: 15, base: 25, bull: 35 }; 
                    if (validPEs.length >= 3) {
                        const minPE = Math.min(...validPEs);
                        const maxPE = Math.max(...validPEs);
                        const avgPE = validPEs.reduce((a, b) => a + b, 0) / validPEs.length;
                        multiples = { bear: Math.floor(minPE * 0.9), base: Math.round(avgPE), bull: Math.ceil(maxPE * 1.1) };
                    }

                    const processed = {
                        name: fundData.General?.Name || cleanSym, ticker: cleanSym, price: currentPrice,
                        description: fundData.General?.Description?.slice(0, 150) + "..." || "Institutional Report",
                        pe_forward: currentFwdPE, market_cap: highlights.MarketCapitalization, ebitda_margin: highlights.EBITDAMarginTTM,
                        rating: "Hold", history: history, estimates: estimates, multiples: multiples,
                        swot: { s: ["Strong Market Position"], w: ["Valuation"], o: ["New Products"], t: ["Competition"] },
                        supply_chain: `graph LR; A-->B`, ecosystem: `graph TD; A-->B`
                    };
                    
                    saveToDatabase(cleanSym, processed);
                    setData(processed);

                } catch (err) {
                    console.error("Final Error Catch", err);
                    setError("Service Unavailable");
                } finally {
                    setLoading(false);
                }
            };

            useEffect(() => { fetchData(ticker); }, [ticker]);
            useEffect(() => {
                try { lucide.createIcons(); if(data && window.mermaid) mermaid.init(); } catch(e) {}
            }, [data]);

            return (
                <div className="min-h-screen pb-20 max-w-[1200px] mx-auto bg-white my-8 rounded-lg shadow-floating p-12">
                    <Header onSearch={setTicker} />
                    {loading ? <div className="flex justify-center items-center h-96"><div className="animate-spin rounded-full h-12 w-12 border-t-4 border-msft-blue"></div></div> :
                     data ? (
                        <div className="mt-8 animate-fade-in">
                            <div className="flex justify-between items-end mb-8 border-b-4 border-gray-100 pb-4">
                                <div><h1 className="text-4xl text-msft-blue font-bold mb-2">{data.name}</h1><span className="text-gray-500 text-lg">Institutional Report V17 | Source: DB + Live</span></div>
                                <div className="text-right"><span className="text-3xl font-bold text-msft-dark">${data.price}</span><span className="block text-sm text-gray-500">Live Market Price</span></div>
                            </div>
                            <ExecSummary data={data} />
                            <KPIGrid data={data} />
                            <TradingViewWidget ticker={data.ticker} />
                            <h2 className="text-2xl text-gray-800 border-l-[6px] border-msft-blue pl-4 mb-6 font-bold">2. ‰º∞ÂÄºËàáË∂®Âã¢ÂàÜÊûê (Valuation)</h2>
                            <PEHistoryChart history={data.history} />
                            <ValuationSection data={data} />
                            <MermaidDiagram chart={data.supply_chain} title="3. Áî¢Ê•≠Èèà‰∏ä‰∏ãÊ∏∏ÂàÜÊûê (Supply Chain)" />
                            <AnalysisTables data={data} />
                            <SWOT swot={data.swot} />
                            <div className="mt-16 text-center text-gray-400 text-sm border-t border-gray-100 pt-8">Generated by Valuation Pro</div>
                        </div>
                    ) : <div className="text-center mt-20">No Data Found or API Error</div>}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
